<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRP Grant Pipeline Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --teal:#8BD0CF;--teal-d:#5BA8A6;--purple:#7C3AED;--blue:#3B82F6;
    --green:#10B981;--amber:#F59E0B;--red:#EF4444;--pink:#EC4899;
    --bg:#f8fafc;--card:#fff;--tx:#1e293b;--tx2:#64748b;--tx3:#94a3b8;--bdr:#e2e8f0;
    --sh:0 1px 3px rgba(0,0,0,.08);--sh2:0 10px 15px -3px rgba(0,0,0,.1);
  }
  body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--tx);display:flex;height:100vh;overflow:hidden}

  .sidebar{width:260px;min-width:260px;background:#0f172a;color:#fff;display:flex;flex-direction:column}
  .s-hdr{padding:24px 20px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
  .s-hdr h1{font-size:17px;font-weight:700;display:flex;align-items:center;gap:10px}
  .s-hdr .ico{width:32px;height:32px;background:var(--teal);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
  .s-hdr p{font-size:11px;color:var(--tx3);margin-top:6px}
  .nav-s{padding:16px 12px 8px}
  .nav-l{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);padding:0 8px 8px}
  .ni{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:#cbd5e1;transition:all .15s;margin-bottom:2px}
  .ni:hover{background:rgba(255,255,255,.06);color:#fff}
  .ni.active{background:var(--teal-d);color:#fff;box-shadow:0 2px 8px rgba(91,168,166,.3)}
  .ni .ic{width:18px;text-align:center;font-size:14px}
  .ni .bg{margin-left:auto;background:rgba(255,255,255,.15);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
  .s-ft{margin-top:auto;padding:16px 20px;border-top:1px solid rgba(255,255,255,.08);font-size:11px;color:var(--tx3)}

  .main{flex:1;overflow-y:auto}
  .topbar{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);padding:14px 32px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
  .topbar h2{font-size:20px;font-weight:700}
  .topbar small{font-size:12px;color:var(--tx3)}
  .ct{padding:24px 32px 40px}
  .vw{display:none}.vw.active{display:block}

  .kpi-g{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:24px}
  .kpi{background:var(--card);border-radius:12px;padding:18px;border:1px solid var(--bdr);position:relative;overflow:hidden;transition:transform .15s,box-shadow .15s}
  .kpi:hover{transform:translateY(-2px);box-shadow:var(--sh2)}
  .kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
  .kpi.ct1::before{background:var(--teal)}.kpi.cg::before{background:var(--green)}.kpi.cp::before{background:var(--purple)}.kpi.ca::before{background:var(--amber)}.kpi.ck::before{background:var(--pink)}
  .kpi-l{font-size:11px;font-weight:500;color:var(--tx2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
  .kpi-v{font-size:26px;font-weight:700}
  .kpi.ct1 .kpi-v{color:var(--teal-d)}.kpi.cg .kpi-v{color:var(--green)}.kpi.cp .kpi-v{color:var(--purple)}.kpi.ca .kpi-v{color:var(--amber)}.kpi.ck .kpi-v{color:var(--pink)}
  .kpi-s{font-size:11px;color:var(--tx3);margin-top:2px}

  .cd{background:var(--card);border-radius:12px;border:1px solid var(--bdr);margin-bottom:20px;overflow:hidden}
  .cd-h{padding:14px 20px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
  .cd-h h3{font-size:15px;font-weight:600}

  table{width:100%;border-collapse:collapse;font-size:12px}
  thead th{background:#f1f5f9;padding:9px 12px;text-align:left;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.05em;color:var(--tx2);border-bottom:2px solid var(--bdr)}
  tbody td{padding:10px 12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
  tbody tr:hover{background:#f8fafc}
  tbody tr{cursor:pointer}

  .bs{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:16px;font-size:11px;font-weight:500;white-space:nowrap}
  .bs::before{content:'';width:6px;height:6px;border-radius:50%}
  .b-ap{background:#d1fae5;color:#065f46}.b-ap::before{background:#10b981}
  .b-su{background:#dbeafe;color:#1e40af}.b-su::before{background:#3b82f6}
  .b-fr{background:#fae8ff;color:#86198f}.b-fr::before{background:#d946ef}
  .b-re{background:#fef3c7;color:#92400e}.b-re::before{background:#f59e0b}
  .b-dr{background:#fed7aa;color:#9a3412}.b-dr::before{background:#f97316}
  .b-ur{background:#e0e7ff;color:#3730a3}.b-ur::before{background:#6366f1}
  .b-rp{background:#fce7f3;color:#9d174d}.b-rp::before{background:#ec4899}
  .b-cl{background:#e2e8f0;color:#475569}.b-cl::before{background:#94a3b8}

  .bar-r{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .bar-l{width:130px;font-size:11px;font-weight:500;text-align:right;color:var(--tx2);flex-shrink:0}
  .bar-t{flex:1;height:22px;background:#f1f5f9;border-radius:6px;overflow:hidden}
  .bar-f{height:100%;border-radius:6px;display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:600;color:#fff;transition:width .6s}
  .bar-v{font-size:11px;font-weight:600;width:80px;text-align:right;flex-shrink:0}

  .dw{display:flex;align-items:center;gap:20px}
  .dlg{display:flex;flex-direction:column;gap:6px}
  .lgi{display:flex;align-items:center;gap:6px;font-size:11px}
  .lgd{width:10px;height:10px;border-radius:3px;flex-shrink:0}

  .fin-g{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;text-align:center;padding:16px 0}
  .fin-l{font-size:11px;color:var(--tx3);margin-bottom:4px}
  .fin-v{font-size:22px;font-weight:700}

  .two-c{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}

  .del-c{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:20px;margin-bottom:14px;border-left:4px solid var(--pink)}
  .del-c h4{font-size:14px;font-weight:600;margin-bottom:6px}
  .del-m{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:10px}
  .del-f label{display:block;font-size:10px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:1px}
  .del-f span{font-size:12px;font-weight:500}
  .req-b{background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:10px 12px;margin-top:10px;font-size:11px;line-height:1.5;color:#92400e}
  .req-b strong{display:block;margin-bottom:3px;font-size:10px;text-transform:uppercase;letter-spacing:.04em}

  .mo-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center}
  .mo-bg.show{display:flex}
  .modal{background:#fff;border-radius:16px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 25px 50px -12px rgba(0,0,0,.25)}
  .mo-h{padding:18px 22px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
  .mo-h h3{font-size:16px;font-weight:700}
  .mo-x{width:30px;height:30px;border:none;background:#f1f5f9;border-radius:8px;cursor:pointer;font-size:16px;color:var(--tx2);display:flex;align-items:center;justify-content:center}
  .mo-b{padding:20px}
  .d-r{display:flex;padding:8px 0;border-bottom:1px solid #f8fafc}
  .d-l{width:150px;font-size:11px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.04em;flex-shrink:0}
  .d-v{font-size:13px;flex:1}

  .search-b{padding:7px 12px;border:1px solid var(--bdr);border-radius:8px;font-size:12px;width:220px;outline:none;font-family:'Montserrat',sans-serif}
  .search-b:focus{border-color:var(--teal)}

  .loading{text-align:center;padding:60px;color:var(--tx3);font-size:14px}
  .spinner{width:32px;height:32px;border:3px solid var(--bdr);border-top-color:var(--teal);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .err-msg{text-align:center;padding:40px;color:var(--red);font-size:13px}

  .ref-btn{background:var(--teal);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;font-family:'Montserrat',sans-serif;transition:background .15s}
  .ref-btn:hover{background:var(--teal-d)}

  @media(max-width:768px){
    .sidebar{width:56px;min-width:56px}.ni span,.s-hdr h1 span,.s-hdr p,.nav-l,.s-ft,.bg{display:none}
    .ct{padding:16px}.kpi-g{grid-template-columns:repeat(2,1fr)}.two-c{grid-template-columns:1fr}.fin-g{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>

<nav class="sidebar">
  <div class="s-hdr">
    <h1><span class="ico">&#9830;</span> <span>Grant Pipeline</span></h1>
    <p>2026 TRP Grant Tracker</p>
  </div>
  <div class="nav-s">
    <div class="nav-l">Pipeline</div>
    <div class="ni active" onclick="go('dashboard',this)"><span class="ic">&#9635;</span> <span>Dashboard</span></div>
    <div class="ni" onclick="go('grants',this)"><span class="ic">&#9776;</span> <span>Grant Application List</span><span class="bg" id="gc">0</span></div>
    <div class="ni" onclick="go('deliverables',this)"><span class="ic">&#10003;</span> <span>Deliverable Tracking</span></div>
  </div>
  <div class="s-ft">TRP Grant Tracker 2026</div>
</nav>

<div class="main">
  <div class="topbar">
    <h2 id="vt">Dashboard</h2>
    <div style="display:flex;align-items:center;gap:12px">
      <small id="upd"></small>
      <button class="ref-btn" onclick="loadAll()">&#8635; Refresh</button>
    </div>
  </div>
  <div class="ct">

    <!-- DASHBOARD -->
    <div class="vw active" id="v-dashboard">
      <div id="dash-load" class="loading"><div class="spinner"></div>Loading live data from Google Sheets...</div>
      <div id="dash-ct" style="display:none">
        <div class="kpi-g" id="kpis"></div>
        <div class="two-c">
          <div class="cd"><div class="cd-h"><h3>Pipeline by Status</h3></div><div style="padding:16px" id="bars"></div></div>
          <div class="cd"><div class="cd-h"><h3>Funding Distribution</h3></div><div style="padding:16px"><div class="dw"><svg viewBox="0 0 160 160" width="150" height="150" id="donut"></svg><div class="dlg" id="leg"></div></div></div></div>
        </div>
        <div class="two-c">
          <div class="cd"><div class="cd-h"><h3>Upcoming Deadlines</h3></div>
            <table><thead><tr><th>Grant</th><th>Deadline</th><th>Days Left</th><th>Status</th></tr></thead><tbody id="dtb"></tbody></table>
          </div>
          <div class="cd"><div class="cd-h"><h3>Financial Summary</h3></div><div class="fin-g" id="fgr"></div></div>
        </div>
        <div class="cd"><div class="cd-h"><h3>Deliverables Overview</h3></div>
          <table><thead><tr><th>Grant</th><th>Type</th><th>Restricted To</th><th>Report Due</th><th>Requirements</th></tr></thead><tbody id="dvtb"></tbody></table>
        </div>
      </div>
    </div>

    <!-- GRANT LIST -->
    <div class="vw" id="v-grants">
      <div class="cd">
        <div class="cd-h"><h3>Grant Application List</h3><input class="search-b" id="gs" placeholder="Search grants..."></div>
        <div style="overflow-x:auto">
          <table><thead><tr><th>Grant Name</th><th>Description</th><th>Deadline</th><th>TRP Contact</th><th>Grant Contact</th><th>Amount</th><th>Status</th><th>Submitted</th><th>Agreement</th><th>Awarded</th><th>Funds</th><th>Complete</th></tr></thead>
          <tbody id="gtb"></tbody></table>
        </div>
      </div>
    </div>

    <!-- DELIVERABLES -->
    <div class="vw" id="v-deliverables">
      <div id="dcards"></div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="mo-bg" id="mobg" onclick="if(event.target===this)cm()">
  <div class="modal"><div class="mo-h"><h3 id="mt"></h3><button class="mo-x" onclick="cm()">&times;</button></div><div class="mo-b" id="mbd"></div></div>
</div>

<script>
// ═══════════════════════════════════════
// GOOGLE SHEET CONFIG
// ═══════════════════════════════════════
const SHEET_ID = '1ivOnWDdkYchQKU7va2BXcksThxZJ5QrC2a0QImzfH00';
const GRANT_GID = '0';
const DELIV_GID = '445039491';

let grants = [];
let deliverables = [];

// ═══════════════════════════════════════
// CSV PARSER
// ═══════════════════════════════════════
function parseCSV(text) {
  const rows = []; let row = []; let field = ''; let inQ = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQ && text[i+1] === '"') { field += '"'; i++; }
      else inQ = !inQ;
    } else if (c === ',' && !inQ) {
      row.push(field.trim()); field = '';
    } else if ((c === '\n' || c === '\r') && !inQ) {
      if (c === '\r' && text[i+1] === '\n') i++;
      row.push(field.trim()); field = '';
      if (row.some(c => c !== '')) rows.push(row);
      row = [];
    } else field += c;
  }
  row.push(field.trim());
  if (row.some(c => c !== '')) rows.push(row);
  return rows;
}

// ═══════════════════════════════════════
// FETCH SHEET DATA
// ═══════════════════════════════════════
async function fetchSheet(gid) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Failed to fetch. Make sure the sheet sharing is set to "Anyone with the link can view".');
  return parseCSV(await r.text());
}

function numParse(v) {
  if (!v) return null;
  const n = parseFloat(v.replace(/[$,]/g, ''));
  return isNaN(n) ? null : n;
}

function toGrants(rows) {
  const out = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || !r[0]) continue;
    out.push({
      name:r[0]||'', desc:r[1]||'', deadline:r[2]||'', trp:r[3]||'',
      contact:r[4]||'', email:r[5]||'', amount:numParse(r[6]),
      amountRaw:r[6]||'', status:r[7]||'', submitted:r[8]||'',
      agreement:r[9]||'', awarded:numParse(r[10]), funds:r[11]||'',
      notes:r[12]||'', folder:r[13]||'',
      complete:(r[14]||'').toUpperCase()==='TRUE'
    });
  }
  return out;
}

function toDeliverables(rows) {
  const out = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || !r[0]) continue;
    out.push({
      name:r[0]||'', id:r[1]||'', period:r[2]||'', assignee:r[3]||'',
      type:r[4]||'', restricted:r[5]||'', due:r[6]||'',
      requirements:r[7]||'', spent:numParse(r[8]),
      remaining:numParse(r[9]), file:r[10]||'', notes:r[11]||''
    });
  }
  return out;
}

async function loadAll() {
  const ld = document.getElementById('dash-load');
  const ct = document.getElementById('dash-ct');
  ld.style.display = 'block'; ct.style.display = 'none';
  try {
    const [gR, dR] = await Promise.all([fetchSheet(GRANT_GID), fetchSheet(DELIV_GID)]);
    grants = toGrants(gR);
    deliverables = toDeliverables(dR);
    document.getElementById('upd').textContent = 'Live \u2022 ' + new Date().toLocaleTimeString();
    document.getElementById('gc').textContent = grants.length;
    renderDash(); renderGrants(); renderDel();
    ld.style.display = 'none'; ct.style.display = 'block';
  } catch(e) {
    ld.innerHTML = '<div class="err-msg"><strong>Could not load data</strong><br><br>' + e.message + '<br><br>Make sure your Google Sheet sharing is set to:<br><strong>"Anyone with the link can view"</strong></div>';
  }
}

// ═══════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════
const $ = s => document.getElementById(s);
const fmt = n => n != null ? '$' + n.toLocaleString() : '\u2014';
const fDate = d => {
  if (!d || d === '\u2014') return '\u2014';
  try { const dt = new Date(d); return isNaN(dt) ? d : dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }
  catch(e) { return d; }
};
const dBtw = (a,b) => { try { return Math.round((new Date(b)-new Date(a))/864e5); } catch(e) { return null; } };
const today = new Date().toISOString().split('T')[0];
const titles = {dashboard:'Dashboard', grants:'Grant Application List', deliverables:'Deliverable Tracking'};

function bCls(s) {
  return {'Approved':'b-ap','Application Submitted':'b-su','Funds Received':'b-fr','Researching':'b-re','Drafting':'b-dr','Under Review':'b-ur','Reporting':'b-rp','Closed':'b-cl'}[s] || 'b-cl';
}
function badge(s) { return s ? '<span class="bs '+bCls(s)+'">'+s+'</span>' : '\u2014'; }

function go(v, el) {
  document.querySelectorAll('.vw').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(x => x.classList.remove('active'));
  $('v-'+v).classList.add('active'); el.classList.add('active');
  $('vt').textContent = titles[v];
}

function om(i) {
  const g = grants[i]; if (!g) return;
  $('mt').textContent = g.name;
  const flds = [['Description',g.desc],['Status',g.status],['Deadline',fDate(g.deadline)],['TRP Contact',g.trp],['Grant Contact',g.contact],['Email',g.email],['Amount',g.amountRaw||fmt(g.amount)],['Submitted',fDate(g.submitted)],['Agreement',g.agreement||'\u2014'],['Awarded',fmt(g.awarded)],['Funds Status',g.funds||'\u2014'],['Notes',g.notes||'\u2014'],['Complete',g.complete?'Yes':'No']];
  $('mbd').innerHTML = flds.map(([l,v]) => '<div class="d-r"><div class="d-l">'+l+'</div><div class="d-v">'+(l==='Status'?badge(v):v)+'</div></div>').join('');
  $('mobg').classList.add('show');
}
function cm() { $('mobg').classList.remove('show'); }
document.addEventListener('keydown', e => { if (e.key==='Escape') cm(); });

// ═══════════════════════════════════════
// RENDER DASHBOARD
// ═══════════════════════════════════════
function renderDash() {
  const tot=grants.length, awarded=grants.reduce((s,g)=>s+(g.awarded||0),0);
  const recv=grants.filter(g=>g.funds==='Funds Received').reduce((s,g)=>s+(g.awarded||0),0);
  const pend=grants.filter(g=>g.status==='Application Submitted').length;
  const rate=tot?Math.round(grants.filter(g=>g.status==='Approved').length/tot*100):0;

  $('kpis').innerHTML=[
    {l:'Total Grants',v:tot,c:'ct1',s:'in pipeline'},
    {l:'Total Awarded',v:fmt(awarded),c:'cg',s:'approved funding'},
    {l:'Funds Received',v:fmt(recv),c:'cp',s:'in hand'},
    {l:'Pending Apps',v:pend,c:'ca',s:'awaiting review'},
    {l:'Approval Rate',v:rate+'%',c:'ck',s:'success rate'}
  ].map(k=>'<div class="kpi '+k.c+'"><div class="kpi-l">'+k.l+'</div><div class="kpi-v">'+k.v+'</div><div class="kpi-s">'+k.s+'</div></div>').join('');

  // Status bars
  const stages=['Approved','Application Submitted','Researching','Drafting','Under Review','Funds Received','Reporting','Closed'];
  const colors=['#10b981','#3b82f6','#f59e0b','#f97316','#6366f1','#d946ef','#ec4899','#94a3b8'];
  const mx=Math.max(...stages.map(s=>grants.filter(g=>g.status===s).length),1);
  $('bars').innerHTML=stages.map((s,i)=>{
    const c=grants.filter(g=>g.status===s).length, a=grants.filter(g=>g.status===s).reduce((x,g)=>x+(g.awarded||0),0);
    const p=Math.max((c/mx)*100,c>0?15:0);
    return '<div class="bar-r"><div class="bar-l">'+s+'</div><div class="bar-t"><div class="bar-f" style="width:'+p+'%;background:'+colors[i]+'">'+c+'</div></div><div class="bar-v">'+fmt(a)+'</div></div>';
  }).join('');

  // Donut
  const dd=stages.map((s,i)=>({l:s,c:grants.filter(g=>g.status===s).length,cl:colors[i]})).filter(d=>d.c>0);
  const t=dd.reduce((s,d)=>s+d.c,0)||1; let ca=-90;
  const svg=$('donut'); svg.innerHTML='';
  if(!dd.length){svg.innerHTML='<text x="80" y="85" text-anchor="middle" fill="#94a3b8" font-size="12">No data</text>';}
  else{dd.forEach(d=>{
    const a=(d.c/t)*360,s1=ca*Math.PI/180,e1=(ca+a)*Math.PI/180,la=a>180?1:0;
    const x1=80+60*Math.cos(s1),y1=80+60*Math.sin(s1),x2=80+60*Math.cos(e1),y2=80+60*Math.sin(e1);
    const ix1=80+35*Math.cos(e1),iy1=80+35*Math.sin(e1),ix2=80+35*Math.cos(s1),iy2=80+35*Math.sin(s1);
    svg.innerHTML+='<path d="M '+x1+' '+y1+' A 60 60 0 '+la+' 1 '+x2+' '+y2+' L '+ix1+' '+iy1+' A 35 35 0 '+la+' 0 '+ix2+' '+iy2+' Z" fill="'+d.cl+'" opacity="0.9"/>';
    ca+=a;});
    svg.innerHTML+='<circle cx="80" cy="80" r="32" fill="white"/>';
    svg.innerHTML+='<text x="80" y="76" text-anchor="middle" fill="#1e293b" font-size="20" font-weight="700">'+t+'</text><text x="80" y="92" text-anchor="middle" fill="#94a3b8" font-size="10">grants</text>';}
  $('leg').innerHTML=dd.map(d=>'<div class="lgi"><div class="lgd" style="background:'+d.cl+'"></div>'+d.l+' ('+d.c+')</div>').join('');

  // Deadlines
  const up=[...grants].filter(g=>g.deadline&&new Date(g.deadline)>=new Date(today)).sort((a,b)=>a.deadline.localeCompare(b.deadline));
  $('dtb').innerHTML=up.length?up.slice(0,8).map(g=>{
    const d=dBtw(today,g.deadline), u=d!=null&&d<=7?'color:var(--red);font-weight:600':d!=null&&d<=30?'color:var(--amber)':'';
    return '<tr onclick="om('+grants.indexOf(g)+')"><td><strong>'+g.name+'</strong></td><td>'+fDate(g.deadline)+'</td><td style="'+u+'">'+(d!=null?d+' days':'\u2014')+'</td><td>'+badge(g.status)+'</td></tr>';
  }).join(''):'<tr><td colspan="4" style="text-align:center;color:var(--tx3);padding:20px">No upcoming deadlines</td></tr>';

  // Financial
  const spent=deliverables.reduce((s,d)=>s+(d.spent||0),0), rem=awarded-spent, util=awarded?Math.round(spent/awarded*100):0;
  $('fgr').innerHTML=[
    {l:'Total Awarded',v:fmt(awarded),c:'var(--green)'},{l:'Total Spent',v:fmt(spent),c:'var(--blue)'},
    {l:'Remaining',v:fmt(rem),c:'var(--amber)'},{l:'Utilization',v:util+'%',c:'var(--purple)'}
  ].map(f=>'<div><div class="fin-l">'+f.l+'</div><div class="fin-v" style="color:'+f.c+'">'+f.v+'</div></div>').join('');

  // Deliverables overview
  $('dvtb').innerHTML=deliverables.map(d=>'<tr><td><strong>'+d.name+'</strong></td><td>'+(d.type||'\u2014')+'</td><td>'+(d.restricted||'\u2014')+'</td><td>'+fDate(d.due)+'</td><td style="max-width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(d.requirements||'\u2014')+'</td></tr>').join('');
}

// ═══════════════════════════════════════
// RENDER GRANT LIST
// ═══════════════════════════════════════
function renderGrants(f) {
  f = f || '';
  const fl=grants.filter(g=>!f||g.name.toLowerCase().includes(f)||g.desc.toLowerCase().includes(f)||g.status.toLowerCase().includes(f));
  $('gtb').innerHTML=fl.map(g=>'<tr onclick="om('+grants.indexOf(g)+')"><td><strong>'+g.name+'</strong></td><td style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+g.desc+'</td><td>'+fDate(g.deadline)+'</td><td>'+g.trp+'</td><td>'+g.contact+'</td><td style="font-weight:600">'+(g.amountRaw||fmt(g.amount))+'</td><td>'+badge(g.status)+'</td><td>'+fDate(g.submitted)+'</td><td style="max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(g.agreement||'\u2014')+'</td><td style="font-weight:600">'+fmt(g.awarded)+'</td><td>'+(g.funds||'\u2014')+'</td><td>'+(g.complete?'<span style="color:var(--green);font-weight:600">Yes</span>':'<span style="color:var(--tx3)">No</span>')+'</td></tr>').join('');
}
$('gs').addEventListener('input', e => renderGrants(e.target.value.toLowerCase()));

// ═══════════════════════════════════════
// RENDER DELIVERABLES
// ═══════════════════════════════════════
function renderDel() {
  $('dcards').innerHTML=deliverables.map(d=>'<div class="del-c"><h4>'+d.name+'</h4><div class="del-m"><div class="del-f"><label>Grant Type</label><span>'+(d.type||'\u2014')+'</span></div><div class="del-f"><label>Restricted To</label><span>'+(d.restricted||'\u2014')+'</span></div><div class="del-f"><label>Report Due</label><span>'+fDate(d.due)+'</span></div><div class="del-f"><label>Amount Spent</label><span>'+fmt(d.spent)+'</span></div><div class="del-f"><label>Remaining</label><span>'+fmt(d.remaining)+'</span></div><div class="del-f"><label>Grant ID</label><span>'+(d.id||'\u2014')+'</span></div></div>'+(d.requirements?'<div class="req-b"><strong>Report Requirements</strong>'+d.requirements.replace(/\n/g,'<br>')+'</div>':'')+'</div>').join('');
}

// ═══════════════════════════════════════
// LOAD ON PAGE OPEN
// ═══════════════════════════════════════
loadAll();
</script>
</body>
</html>
